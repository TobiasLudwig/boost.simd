<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.13"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.smartmenus/1.0.1/jquery.smartmenus.js"></script>
        <title>Boost.SIMD: Distance between Points Part 2</title>
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/SVG"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link rel="icon" href="numscale_icon.png">
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="ns.css" rel="stylesheet" type="text/css"/>
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="ns.js"></script>
        <script type="text/javascript" src="custom.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header responsive-logo"/>
                    <a class="navbar-brand" href="http://developer.numscale.com/">
                        <span>Boost.SIMD</span>
                    </a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li id="version">
                            <a href="#" class="disabled">4.17.6.0</a>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a target="_blank" id="right-logo" href="http://www.numscale.com/" title="Numscale">
                                <img height=60 src="numscale.png" alt="Numscale">
                            </a>
                        </li>
                    </ul>
                </div><!-- /.navbar-collapse -->
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 35px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Distance between Points Part 2 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#distance-hypot-objectives">Objectives</a></li>
<li class="level1"><a href="#distance-hypot-intro">Using the hypot function</a><ul><li class="level2"><a href="#distance-hypot-simd">The SIMD Calculation</a></li>
<li class="level2"><a href="#distance-hypot-performance">Performance</a></li>
<li class="level2"><a href="#distance-hypot-fast">Fast Boost.SIMD functions</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-distance.html">Distance between 2D Points</a></div> <div style="text-align: right;" markdown="1">Next:<a class="el" href="tutorial-julia.html">Vectorizing the Julia Set Calculation</a></div><p>In this tutorial we will extend the previous tutorial which demonstrated how to calculate the distance between between a 2D reference point and a vector of 2D points by introducing several other methods of performing the same calculation. These additional methods are not just syntactic changes - they have a significant effect on the performance and precision of the calculation.</p>
<h1><a class="anchor" id="distance-hypot-objectives"></a>
Objectives</h1>
<hr/>
<p>In this tutorial we will:</p><ul>
<li><a href="#distance-hypot-intro">Compare scalar and SIMD calculations using hypot function</a></li>
<li><a href="#distance-hypot-fast">Introduce the 'fast' versions of Boost.SIMD functions</a></li>
</ul>
<h1><a class="anchor" id="distance-hypot-intro"></a>
Using the hypot function</h1>
<p>Both the C++ standard library and <b>Boost.SIMD</b> provide the function hypot, which calculates the the square root of the sum of the squares of \(x\) and \(y\), without undue overflow or underflow at intermediate stages of the computation, <a href="http://en.cppreference.com/w/cpp/numeric/math/hypot">cppreference.</a></p>
<p>We wish to vectorize the following scalar code</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_points; ++i) {</div><div class="line">    <span class="keyword">auto</span> x       = refX - X[i];</div><div class="line">    <span class="keyword">auto</span> y       = refY - Y[i];</div><div class="line">    distance0[i] = <a class="code" href="group__group-arithmetic_ga8490268a1e9275d9311157cca9396d75.html#ga8490268a1e9275d9311157cca9396d75">std::hypot</a>(refX - X[i], refY - Y[i]);</div><div class="line">  }</div></div><!-- fragment --> <h2><a class="anchor" id="distance-hypot-simd"></a>
The SIMD Calculation</h2>
<p>This code is trivial to vectorize using <b>Boost.SIMD</b></p>
<div class="fragment"><div class="line">  pack_t vrefX = pack_t(refX);</div><div class="line">  pack_t vrefY = pack_t(refY);</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_points; i += pack_t::static_size) {</div><div class="line">    pack_t vX  = bs::aligned_load&lt;pack_t&gt;(&amp;X[i]);</div><div class="line">    pack_t vY  = bs::aligned_load&lt;pack_t&gt;(&amp;Y[i]);</div><div class="line">    pack_t res = <a class="code" href="group__group-decorator_gae3bd90706ed757cdc1836339c702482b.html#gae3bd90706ed757cdc1836339c702482b">bs::pedantic_</a>(<a class="code" href="group__group-arithmetic_ga8490268a1e9275d9311157cca9396d75.html#ga8490268a1e9275d9311157cca9396d75">bs::hypot</a>)(vrefX - vX, vrefY - vY);</div><div class="line">    <a class="code" href="namespaceboost_1_1simd.html#aaa551993873d3636d339e3ef32ffb56b">bs::aligned_store</a>(res, &amp;distance1[i]);</div><div class="line">  }</div></div><!-- fragment --><p> Note that in this version we have used the <code>pedantic_</code> decorator to use the <a class="el" href="namespaceboost_1_1simd.html" title="Main Boost.SIMD namespace. ">boost.simd</a> version of hypot that is the closest to the <code>std::hypot</code> function behaviour.</p>
<h2><a class="anchor" id="distance-hypot-performance"></a>
Performance</h2>
<p>As was done in the previous example, this code was compiled using g++-6.0 with all optimizations enabled and run on an Intel Xeon CPU E3-1240 v3 @ 3.40GHz. The following results were obtained when the code was compiled for SSE4.2</p>
<table align="center" width="25%" class="table-striped table-bordered">
<tr>
<th>Loop </th><th>Time ( \(\mu s\)) </th></tr>
<tr>
<td>Scalar </td><td>8639 </td></tr>
<tr>
<td>SIMD </td><td>6417 </td></tr>
</table>
<p>We note that the performance of both the scalar and SIMD versions is much slower than in the previous tutorial - this is the price paid for increased precision and detection of under and overflow at intermediate stages of the computation.</p>
<h2><a class="anchor" id="distance-hypot-fast"></a>
Fast Boost.SIMD functions</h2>
<p>In many cases, the detection of under or overflow at intermediate stages of the computation is not required, for example, if the input data is known to be in a certain range. Therefore, <b>Boost.SIMD</b> provides regular versions of certain functions which omit these checks.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_points; i += pack_t::static_size) {</div><div class="line">    pack_t vX  = bs::aligned_load&lt;pack_t&gt;(&amp;X[i]);</div><div class="line">    pack_t vY  = bs::aligned_load&lt;pack_t&gt;(&amp;Y[i]);</div><div class="line">    pack_t res = <a class="code" href="group__group-arithmetic_ga8490268a1e9275d9311157cca9396d75.html#ga8490268a1e9275d9311157cca9396d75">bs::hypot</a>(vrefX - vX, vrefY - vY);</div><div class="line">    <a class="code" href="namespaceboost_1_1simd.html#aaa551993873d3636d339e3ef32ffb56b">bs::aligned_store</a>(res, &amp;distance2[i]);</div><div class="line">  }</div></div><!-- fragment --><p> Again, using SSE4.2 instructions, the following performance was observed:</p>
<table align="center" width="25%" class="table-striped table-bordered">
<tr>
<th>Loop </th><th>Time ( \(\mu s\)) </th></tr>
<tr>
<td>Scalar </td><td>8639 </td></tr>
<tr>
<td>SIMD </td><td>6417 </td></tr>
<tr>
<td>SIMD 'fast' </td><td>1328 </td></tr>
</table>
<p>We note here that the performance using regular hypot is equal to that obtained in the previous tutorial's SIMD calculation.</p>
<div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-distance.html">Distance between 2D Points</a></div> <div style="text-align: right;" markdown="1">Next:<a class="el" href="tutorial-julia.html">Vectorizing the Julia Set Calculation</a></div> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="footer"/>
        <address class="footer">
            <small>
                Generated on Fri Jun 9 2017 10:01:40 for Boost.SIMD by &#160;
                <a href="http://www.doxygen.org/index.html">
                    <img class="footer" src="doxygen.png" alt="doxygen"/>
                </a>
                1.8.13
            </small>
        </address>
    </body>
</html>
