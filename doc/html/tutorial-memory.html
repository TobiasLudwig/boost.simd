<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.13"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.smartmenus/1.0.1/jquery.smartmenus.js"></script>
        <title>Boost.SIMD: Memory Alignment</title>
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/SVG"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link rel="icon" href="numscale_icon.png">
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="ns.css" rel="stylesheet" type="text/css"/>
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="ns.js"></script>
        <script type="text/javascript" src="custom.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header responsive-logo"/>
                    <a class="navbar-brand" href="http://developer.numscale.com/">
                        <span>Boost.SIMD</span>
                    </a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li id="version">
                            <a href="#" class="disabled">4.17.6.0</a>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a target="_blank" id="right-logo" href="http://www.numscale.com/" title="Numscale">
                                <img height=60 src="numscale.png" alt="Numscale">
                            </a>
                        </li>
                    </ul>
                </div><!-- /.navbar-collapse -->
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 35px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Memory Alignment </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#memory-objectives">Objectives</a></li>
<li class="level1"><a href="#memory-what-is">What is Memory Alignment</a></li>
<li class="level1"><a href="#memory-how-to-align">How to Align Memory Manually?</a></li>
<li class="level1"><a href="#memory-boost-simd-align">How to Align Memory using Boost.SIMD allocation function</a></li>
<li class="level1"><a href="#memory-vector">How to use Boost.SIMD standard compliant aligned memory allocator</a></li>
</ul>
</div>
<div class="textblock"><div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-simd-loop.html">A Basic SIMD Loop</a></div> <div style="text-align: right;" markdown="1">Next: <a class="el" href="tutorial-mathematical.html">Using Mathematical Functions</a></div><p>All of the previous tutorials assumed that the memory allocated for the input and output buffers was correctly aligned. Depending on your memory allocator and architecture, this may not always be true. In this tutorial we will discuss memory alignment and demonstrate how to ensure that your memory is always correctly aligned.</p>
<h1><a class="anchor" id="memory-objectives"></a>
Objectives</h1>
<hr/>
<p>In this tutorial we will:</p><ul>
<li><a href="#memory-what-is">Explain what memory alignemnt is</a></li>
<li><a href="#memory-how-to-align">Demonstrate how to align memory</a></li>
<li><a href="#memory-boost-simd-align">Demonstrate how to align memory using Boost.SIMD</a></li>
<li><a href="#memory-vector">Demonstrate how to use an aligned memory allocator with STL containers</a></li>
</ul>
<h1><a class="anchor" id="memory-what-is"></a>
What is Memory Alignment</h1>
<p>In order to fully understand memory alignment and how to maximize performance of your software by ensuring memory alignment, please read this excellent article by <a href="http://www.ibm.com/developerworks/library/pa-dalign/">IBM</a>. Although this article focuses on PowerPC processors, its conclusions are valid on many other architectures. <b>Boost.SIMD</b> gives you portability across many architectures, in order to have the best performance possible across a range of architectures, it is worth considering the alignment requirements of all target architectures.</p>
<h1><a class="anchor" id="memory-how-to-align"></a>
How to Align Memory Manually?</h1>
<p>It is possible to align memory yourself using <code>std::align</code>. In the following example, we allocate memory and store it in a unique_ptr. This pointer is then shifted until it is aligned on the requested boundary. This means that the allocated buffer must be larger than the size required, at least <code>pack_t::alignment</code> (the required alignment for a pack of this type on the target architecture) bytes larger.</p>
<div class="fragment"><div class="line">    <span class="keyword">namespace </span><a class="code" href="namespaceboost_1_1simd.html">bs</a> = <a class="code" href="namespaceboost_1_1simd.html">boost::simd</a>;</div><div class="line">    <span class="keyword">using</span> pack_t = <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int&gt;</a>;</div><div class="line"></div><div class="line">    std::size_t num_elements = 1024;</div><div class="line">    std::size_t alignment    = pack_t::alignment;</div><div class="line">    std::size_t buffer_size  = num_elements + alignment;</div><div class="line">    std::unique_ptr&lt;char[]&gt; ptr(<span class="keyword">new</span> <span class="keywordtype">char</span>[buffer_size]);</div><div class="line">    <span class="keywordtype">void</span>* pv = ptr.get();</div><div class="line">    <span class="keywordflow">if</span> (std::align(alignment, num_elements, pv, buffer_size) == <span class="keyword">nullptr</span>) {</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot; alignment failed &quot;</span> &lt;&lt; std::endl;</div><div class="line">    }</div></div><!-- fragment --><p> As you can see, this is error-prone, difficult and quite annoying to do. The easiest way to align memory is to use the aligned memory allocator provided by <b>Boost.SIMD</b>.</p>
<h1><a class="anchor" id="memory-boost-simd-align"></a>
How to Align Memory using Boost.SIMD allocation function</h1>
<p>The allocation function provided by <b>Boost.SIMD</b> guarantees to return a pointer with the correct alignment so that you need not worry about allocating extra space in the buffer to account for the required alignment as in the previous section. It also has the advantage of returning a typed pointer and automatically deduces the correct alignment depending on the target architecture.</p>
<dl class="section note">
<dt>Note</dt>
<dd>The additional template parameter passed to the <code>std::unique_ptr</code> is the associated delete function. </dd>
</dl>
<div class="fragment"><div class="line">    std::size_t num_elements = 1024;</div><div class="line">    <span class="keyword">using</span> aligned_ptr        = std::unique_ptr&lt;int[], boost::simd::aligned_delete&gt;;</div><div class="line"></div><div class="line">    aligned_ptr ptr2(boost::simd::allocate&lt;int&gt;(num_elements));</div></div><!-- fragment --> <h1><a class="anchor" id="memory-vector"></a>
How to use Boost.SIMD standard compliant aligned memory allocator</h1>
<p>The C++ STL containers allow you to use a custom memory allocator by passing an additional template argument during the declaration, in a similar manner to the previous example using <code>std::unique_ptr</code>. You can use <a class="el" href="group__group-api_ga8d2eaa1a85935a7a87928a50792d822f.html#ga8d2eaa1a85935a7a87928a50792d822f" title="Convenience alias defining a standard compliant allocator returning memory which alignment is compati...">boost::simd::allocator</a> with an <code>std::vector</code> as follows:</p>
<div class="fragment"><div class="line">    std::size_t num_elements = 1024;</div><div class="line">    std::vector&lt;int, boost::simd::allocator&lt;float&gt;&gt; input_buffer(num_elements);</div></div><!-- fragment --><p> The data stored in this vector may be used by Boost.SIMD as an input or output buffer.</p>
<div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-simd-loop.html">A Basic SIMD Loop</a></div> <div style="text-align: right;" markdown="1">Next: <a class="el" href="tutorial-mathematical.html">Using Mathematical Functions</a></div> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="footer"/>
        <address class="footer">
            <small>
                Generated on Fri Jun 9 2017 10:01:40 for Boost.SIMD by &#160;
                <a href="http://www.doxygen.org/index.html">
                    <img class="footer" src="doxygen.png" alt="doxygen"/>
                </a>
                1.8.13
            </small>
        </address>
    </body>
</html>
