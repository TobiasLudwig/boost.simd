<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.13"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.smartmenus/1.0.1/jquery.smartmenus.js"></script>
        <title>Boost.SIMD: N-Body Problem</title>
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/SVG"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link rel="icon" href="numscale_icon.png">
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="ns.css" rel="stylesheet" type="text/css"/>
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="ns.js"></script>
        <script type="text/javascript" src="custom.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header responsive-logo"/>
                    <a class="navbar-brand" href="http://developer.numscale.com/">
                        <span>Boost.SIMD</span>
                    </a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li id="version">
                            <a href="#" class="disabled">4.17.6.0</a>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a target="_blank" id="right-logo" href="http://www.numscale.com/" title="Numscale">
                                <img height=60 src="numscale.png" alt="Numscale">
                            </a>
                        </li>
                    </ul>
                </div><!-- /.navbar-collapse -->
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 35px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">N-Body Problem </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#tutorial-nbody-objectives">Objectives</a></li>
<li class="level1"><a href="#tutorial-nbody-intro">N-Body Problem</a></li>
<li class="level1"><a href="#tutorial-nbody-calc">Calculation</a></li>
<li class="level1"><a href="#tutorial-nbody-performance">Performance</a></li>
</ul>
</div>
<div class="textblock"><div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-neural.html">Evaluation of a Neural Network</a></div> <div style="text-align: right;" markdown="1">Next: <a class="el" href="tutorial-runtime.html">Runtime Extension Selection</a></div><p>In this tutorial we will show you how to optimize an n-body simulation using <b>Boost.SIMD</b>,</p>
<h1><a class="anchor" id="tutorial-nbody-objectives"></a>
Objectives</h1>
<hr/>
<p>In this tutorial we will:</p><ul>
<li><a href="#tutorial-nbody-intro">Introduce the N-body Problem</a></li>
<li><a href="#tutorial-nbody-calc">Demonstrate how to perform an N-body simulation ysing Boost.SIMD</a></li>
</ul>
<h1><a class="anchor" id="tutorial-nbody-intro"></a>
N-Body Problem</h1>
<hr/>
<p>This problem is concerned with the calculation of the individual motion of celestial objects caused by gravity. This is an example of a problem of \(N^2\) complexity. The formula to calculate the gravitational force between two objects is:</p>
<p class="formulaDsp">
\[F=\frac{Gm_im_j(q_i - q_j)}{{\|q_i-q_j\|}^3}\]
</p>
<p>Where: \(\mathbf{q_i}\) is the position vector of object \(i\) \(\mathbf{m_i}\) is the mass of object \(i\) \(G\) is the gravitational constant</p>
<h1><a class="anchor" id="tutorial-nbody-calc"></a>
Calculation</h1>
<hr/>
<p>The scalar calculation of this problem is done as follows:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> nbody_step_scalar(particles&amp; ps)</div><div class="line">{</div><div class="line">  T epsilon = 0.00125f;</div><div class="line">  <span class="keywordflow">for</span> (std::size_t i = 0; i &lt; ps.size(); ++i) {</div><div class="line">    T ax{0};</div><div class="line">    T ay{0};</div><div class="line">    T az{0};</div><div class="line"></div><div class="line">    T pix = ps.x[i];</div><div class="line">    T piy = ps.y[i];</div><div class="line">    T piz = ps.z[i];</div><div class="line"></div><div class="line">    T pim = ps.m[i];</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (std::size_t j = i + 1; j &lt; ps.size(); ++j) {</div><div class="line">      T pjx = ps.x[j];</div><div class="line">      T pjy = ps.y[j];</div><div class="line">      T pjz = ps.z[j];</div><div class="line"></div><div class="line">      T dx = pjx - pix;</div><div class="line">      T dy = pjy - piy;</div><div class="line">      T dz = pjz - piz;</div><div class="line"></div><div class="line">      T inorm = 6.667408e-11 / <a class="code" href="group__group-arithmetic_gad9e0c99d40f784f214a728ab53139d15.html#gad9e0c99d40f784f214a728ab53139d15">std::sqrt</a>(dx * dx + dy * dy + dz * dz + epsilon);</div><div class="line"></div><div class="line">      T fi = ps.m[j] * inorm * inorm * inorm;</div><div class="line">      T fj = pim * inorm * inorm * inorm;</div><div class="line"></div><div class="line">      ax += dx * fi;</div><div class="line">      ay += dy * fi;</div><div class="line">      az += dz * fi;</div><div class="line"></div><div class="line">      ps.vx[j] -= dx * fj;</div><div class="line">      ps.vy[j] -= dy * fj;</div><div class="line">      ps.vz[j] -= dz * fj;</div><div class="line">    }</div><div class="line"></div><div class="line">    T pivx = ps.vx[i];</div><div class="line">    T pivy = ps.vy[i];</div><div class="line">    T pivz = ps.vz[i];</div><div class="line"></div><div class="line">    pivx += ax;</div><div class="line">    pivy += ay;</div><div class="line">    pivz += az;</div><div class="line"></div><div class="line">    pix += pivx;</div><div class="line">    piy += pivy;</div><div class="line">    piz += pivz;</div><div class="line"></div><div class="line">    ps.vx[i] = pivx;</div><div class="line">    ps.vy[i] = pivy;</div><div class="line">    ps.vz[i] = pivz;</div><div class="line"></div><div class="line">    ps.x[i] = pix;</div><div class="line">    ps.y[i] = piy;</div><div class="line">    ps.z[i] = piz;</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><p> Note the use of a small constant, \(\epsilon\). This is referred to as <em>softening</em>, a numerical trick to prevent division by zero if two particles are too close together.</p>
<p>This calculation is trivially vectorizable as follows:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> nbody_step(particles&amp; ps)</div><div class="line">{</div><div class="line">  pack_t grav_con{6.67408e-11};</div><div class="line">  pack_t epsilon{0.00125f};</div><div class="line">  <span class="keywordflow">for</span> (std::size_t i = 0; i &lt; ps.size(); i += pack_t::static_size) {</div><div class="line">    pack_t ax{0};</div><div class="line">    pack_t ay{0};</div><div class="line">    pack_t az{0};</div><div class="line"></div><div class="line">    pack_t pix{&amp;ps.x[i]};</div><div class="line">    pack_t piy{&amp;ps.y[i]};</div><div class="line">    pack_t piz{&amp;ps.z[i]};</div><div class="line"></div><div class="line">    pack_t pim{&amp;ps.m[i]};</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (std::size_t j = i + 1; j &lt; ps.size(); ++j) {</div><div class="line">      <span class="keyword">auto</span> pjx = bs::load&lt;pack_t&gt;(&amp;ps.x[j]);</div><div class="line">      <span class="keyword">auto</span> pjy = bs::load&lt;pack_t&gt;(&amp;ps.y[j]);</div><div class="line">      <span class="keyword">auto</span> pjz = bs::load&lt;pack_t&gt;(&amp;ps.z[j]);</div><div class="line"></div><div class="line">      <span class="keyword">auto</span> dx = pjx - pix;</div><div class="line">      <span class="keyword">auto</span> dy = pjy - piy;</div><div class="line">      <span class="keyword">auto</span> dz = pjz - piz;</div><div class="line"></div><div class="line">      <span class="keyword">auto</span> inorm  = grav_con / <a class="code" href="group__group-arithmetic_gad9e0c99d40f784f214a728ab53139d15.html#gad9e0c99d40f784f214a728ab53139d15">bs::sqrt</a>(dx * dx + dy * dy + dz * dz + epsilon);</div><div class="line">      <span class="keyword">auto</span> inorm3 = inorm * inorm * inorm;</div><div class="line"></div><div class="line">      <span class="keyword">auto</span> fi = bs::load&lt;pack_t&gt;(&amp;ps.m[j]) * inorm3;</div><div class="line">      <span class="keyword">auto</span> fj = pim * inorm3;</div><div class="line"></div><div class="line">      ax += dx * fi;</div><div class="line">      ay += dy * fi;</div><div class="line">      az += dz * fi;</div><div class="line"></div><div class="line">      <span class="keyword">auto</span> pjvx = bs::load&lt;pack_t&gt;(&amp;ps.vx[j]);</div><div class="line">      pjvx -= dx * fj;</div><div class="line">      <a class="code" href="namespaceboost_1_1simd.html#af50789733f52bd58296f90d91b5b3b3e">bs::store</a>(pjvx, &amp;ps.vx[j]);</div><div class="line">      <span class="keyword">auto</span> pjvy = bs::load&lt;pack_t&gt;(&amp;ps.vy[j]);</div><div class="line">      pjvy -= dy * fj;</div><div class="line">      <a class="code" href="namespaceboost_1_1simd.html#af50789733f52bd58296f90d91b5b3b3e">bs::store</a>(pjvy, &amp;ps.vy[j]);</div><div class="line">      <span class="keyword">auto</span> pjvz = bs::load&lt;pack_t&gt;(&amp;ps.vz[j]);</div><div class="line">      pjvz -= dz * fj;</div><div class="line">      <a class="code" href="namespaceboost_1_1simd.html#af50789733f52bd58296f90d91b5b3b3e">bs::store</a>(pjvz, &amp;ps.vz[j]);</div><div class="line">    }</div><div class="line"></div><div class="line">    pack_t pivx{&amp;ps.vx[i]};</div><div class="line">    pack_t pivy{&amp;ps.vy[i]};</div><div class="line">    pack_t pivz{&amp;ps.vz[i]};</div><div class="line"></div><div class="line">    pivx += ax;</div><div class="line">    pivy += ay;</div><div class="line">    pivz += az;</div><div class="line"></div><div class="line">    pix += pivx;</div><div class="line">    piy += pivy;</div><div class="line">    piz += pivz;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceboost_1_1simd.html#aaa551993873d3636d339e3ef32ffb56b">bs::aligned_store</a>(pivx, &amp;ps.vx[i]);</div><div class="line">    <a class="code" href="namespaceboost_1_1simd.html#aaa551993873d3636d339e3ef32ffb56b">bs::aligned_store</a>(pivy, &amp;ps.vy[i]);</div><div class="line">    <a class="code" href="namespaceboost_1_1simd.html#aaa551993873d3636d339e3ef32ffb56b">bs::aligned_store</a>(pivz, &amp;ps.vz[i]);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceboost_1_1simd.html#aaa551993873d3636d339e3ef32ffb56b">bs::aligned_store</a>(pix, &amp;ps.x[i]);</div><div class="line">    <a class="code" href="namespaceboost_1_1simd.html#aaa551993873d3636d339e3ef32ffb56b">bs::aligned_store</a>(piy, &amp;ps.y[i]);</div><div class="line">    <a class="code" href="namespaceboost_1_1simd.html#aaa551993873d3636d339e3ef32ffb56b">bs::aligned_store</a>(piz, &amp;ps.z[i]);</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --> <dl class="section note">
<dt>Note</dt>
<dd>All constants are loaded into <b>SIMD</b> vectors outside of the main loop, so that these vectors are not generated each iteration of the calculation. </dd>
</dl>
<p>It is not possible to use aligned stores in the interior loop as these stores will not be aligned for each store.</p>
<h1><a class="anchor" id="tutorial-nbody-performance"></a>
Performance</h1>
<p>This code as compiled using g++6.0 for sse4.2 and avx2. It was executed on an Intel Xeon CPU E3-1240 v3 @ 3.40GHz. The following results were obtained:</p>
<table align="center" width="25%" class="table-striped table-bordered">
<tr>
<th>Loop </th><th>Time ( \(\mu s\)) </th><th>Speed-up </th></tr>
<tr>
<td>Scalar </td><td>13185 </td><td></td></tr>
<tr>
<td>SIMD SSE4.2 </td><td>4104 </td><td>x3.21 </td></tr>
<tr>
<td>SIMD AVX2 </td><td>2321 </td><td>x5.68 </td></tr>
</table>
<p>The performance obtained is broadly in line with the theoretical maximum possible speed-ups of x4 for SSE4.2 and x8 for AVX2. There are very few problems where these theoretical speed-ups are obtainable.</p>
<div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-neural.html">Evaluation of a Neural Network</a></div> <div style="text-align: right;" markdown="1">Next: <a class="el" href="tutorial-runtime.html">Runtime Extension Selection</a></div> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="footer"/>
        <address class="footer">
            <small>
                Generated on Fri Jun 9 2017 10:01:40 for Boost.SIMD by &#160;
                <a href="http://www.doxygen.org/index.html">
                    <img class="footer" src="doxygen.png" alt="doxygen"/>
                </a>
                1.8.13
            </small>
        </address>
    </body>
</html>
