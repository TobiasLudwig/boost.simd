<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.13"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.smartmenus/1.0.1/jquery.smartmenus.js"></script>
        <title>Boost.SIMD: A SIMD Loop</title>
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/SVG"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link rel="icon" href="numscale_icon.png">
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="ns.css" rel="stylesheet" type="text/css"/>
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="ns.js"></script>
        <script type="text/javascript" src="custom.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header responsive-logo"/>
                    <a class="navbar-brand" href="http://developer.numscale.com/">
                        <span>Boost.SIMD</span>
                    </a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li id="version">
                            <a href="#" class="disabled">4.17.6.0</a>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a target="_blank" id="right-logo" href="http://www.numscale.com/" title="Numscale">
                                <img height=60 src="numscale.png" alt="Numscale">
                            </a>
                        </li>
                    </ul>
                </div><!-- /.navbar-collapse -->
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 35px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">A SIMD Loop </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#sum-objectives">Objectives</a></li>
<li class="level1"><a href="#substract-scalar-simd">Transforming a scalar loop into a SIMD loop</a><ul><li class="level2"><a href="#substract-constant">Filling the subtraction pack</a></li>
<li class="level2"><a href="#substract-construct-loop">Constructing the loop</a></li>
<li class="level2"><a href="#substract-load-simd">Filling the loop</a></li>
</ul>
</li>
<li class="level1"><a href="#substract-hanging-data">What happens when the input data is not a multiple of the cardinal?</a></li>
</ul>
</div>
<div class="textblock"><div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-hello.html">The SIMD Hello World</a></div> <div style="text-align: right;" markdown="1">Next: <a class="el" href="tutorial-memory.html">Memory Alignment</a></div><p> In this tutorial we will demonstrate how to construct a SIMD loop to subtract a constant from a vector of input data.</p>
<h1><a class="anchor" id="sum-objectives"></a>
Objectives</h1>
<hr/>
<p>In this tutorial we will:</p><ul>
<li><a href="#substract-scalar-simd">Transform a scalar loop into a <b>SIMD</b> loop</a></li>
<li><a href="#substract-construct-loop">Loop over the input data and perform the calculation on several elements at once</a></li>
<li><a href="#substract-hanging-data">Show how handle cases where the number of input data is not an exact multiple of the size of a pack</a></li>
</ul>
<h1><a class="anchor" id="substract-scalar-simd"></a>
Transforming a scalar loop into a SIMD loop</h1>
<p>In this tutorial we will demonstrate how to transform the following scalar loop into a <b>SIMD</b> loop:</p>
<p>Let us suppose we have a size 128 filled of <code>int32_t</code> array <code>array</code>, an output array <code>out</code> of the same size and a scalar value <code>scalar</code>:</p>
<div class="fragment"><div class="line">  <span class="keyword">namespace </span><a class="code" href="namespaceboost_1_1simd.html">bs</a> = <a class="code" href="namespaceboost_1_1simd.html">boost::simd</a>;</div><div class="line"></div><div class="line">  <span class="keywordtype">size_t</span> size = 128;</div><div class="line">  std::vector&lt;int32_t&gt; array(size);</div><div class="line">  std::vector&lt;int32_t&gt; out(size);</div><div class="line">  <span class="comment">// Initialize input array</span></div><div class="line">  <a class="code" href="group__group-algo_gadb2705dba33a162bffe7656b7fe6c32c.html#gadb2705dba33a162bffe7656b7fe6c32c">std::iota</a>(array.begin(), array.end(), 0);</div><div class="line">  int32_t scalar = 42;</div></div><!-- fragment --><p> We would like to perform in <b>SIMD</b> the analogous of following scalar loop:</p>
<div class="fragment"><div class="line">  <span class="comment">// Scalar version</span></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; ++i) {</div><div class="line">    out[i] = array[i] - scalar;</div><div class="line">  }</div></div><!-- fragment --><p> The first step is to determine the number of elements in a pack of the chosen primitive type, in this case an <code>int32_t</code>. It is generally easiest and safest to use the default pack size, corresponding to the size of the available physical <b>SIMD</b> registers. This size may be obtained using the <a class="el" href="structboost_1_1simd_1_1cardinal__of.html" title="Computes the register width required to store an instance of any type T. ">boost::simd::cardinal_of</a> function.</p>
<div class="fragment"><div class="line">  <span class="keyword">using</span> pack_t     = <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int32_t&gt;</a>;</div><div class="line">  <span class="keywordtype">size_t</span> pack_card = <a class="code" href="structboost_1_1simd_1_1cardinal__of.html">bs::cardinal_of&lt;pack_t&gt;</a>();</div></div><!-- fragment --><p> This size may also be accessed through the member variable pack_t::static_size.</p>
<p>We shall first assume that the size of our array is a multiple of the cardinal of the pack. Please note that this assumption is very unsafe as code written using <b>Boost.SIMD</b> is designed to be portable across multiple architectures! The more realistic case where this is no longer true is demonstrated afterwards.</p>
<h2><a class="anchor" id="substract-constant"></a>
Filling the subtraction pack</h2>
<p>We wish to subtract <code>42</code> from each element in the input data. We therefore fill a vector will this value in the exact same way as in the previous tutorial.</p>
<div class="fragment"><div class="line">    pack_t p_out, fortytwo(scalar);</div></div><!-- fragment --> <h2><a class="anchor" id="substract-construct-loop"></a>
Constructing the loop</h2>
<p>We now construct our loop. Note how <code>i</code> is incremented by the cardinal of the pack as we process <code>cardinal</code> elements of the input data for each iteration of the loop.</p>
<div class="fragment"><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; i += pack_card) {</div><div class="line">    }</div></div><!-- fragment --> <h2><a class="anchor" id="substract-load-simd"></a>
Filling the loop</h2>
<p>In order to process the input data, we must load load the data from memory using <a class="el" href="namespaceboost_1_1simd_a44f9b5b1a343b238a3a80a52365ec860.html#a44f9b5b1a343b238a3a80a52365ec860" title="Load a value from memory into a generic variable. ">boost::simd::load</a> and then store it afterwards back in memory using <a class="el" href="namespaceboost_1_1simd_af5521b79da254d7133fa74cfaf547e10.html#af5521b79da254d7133fa74cfaf547e10" title="Store a value at an arbitrary memory location. ">boost::simd::store</a> These functions are accessed by including the following headers:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;boost/simd/function/load.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/simd/function/store.hpp&gt;</span></div></div><!-- fragment --><p> We shall construct our pack with a pointer to the data we wish to load. We then perform the subtraction using the operator <code>-</code> and then store the data using <a class="el" href="namespaceboost_1_1simd_af5521b79da254d7133fa74cfaf547e10.html#af5521b79da254d7133fa74cfaf547e10" title="Store a value at an arbitrary memory location. ">boost::simd::store</a></p>
<div class="fragment"><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; i += pack_card) {</div><div class="line">      pack_t p_arr(array.data() + i);</div><div class="line">      p_out = p_arr - fortytwo;</div><div class="line">      <a class="code" href="namespaceboost_1_1simd.html#af50789733f52bd58296f90d91b5b3b3e">bs::store</a>(p_out, out.data() + i);</div><div class="line">    }</div></div><!-- fragment --><p> Note that <code>fortytwo</code>, the pack of constants to be subtracted from the input data, is declared outside of the loop so that it is not loaded at each iteration. Generally speaking, any compiler which supports <b>Boost.SIMD</b> would automatically optimize this, although it is better to be safe!</p>
<p>If we wish to declare our pack outside of the loop, for example, if we wish to re-use it later, we can load the data using <a class="el" href="namespaceboost_1_1simd_a44f9b5b1a343b238a3a80a52365ec860.html#a44f9b5b1a343b238a3a80a52365ec860" title="Load a value from memory into a generic variable. ">boost::simd::load</a>:</p>
<div class="fragment"><div class="line">    <span class="comment">// Using explicit load/store</span></div><div class="line">    pack_t p_out, p_arr, fortytwo{scalar};</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; i += pack_card) {</div><div class="line">      p_arr = bs::load&lt;pack_t&gt;(array.data() + i);</div><div class="line">      p_out = p_arr - fortytwo;</div><div class="line">      <a class="code" href="namespaceboost_1_1simd.html#af50789733f52bd58296f90d91b5b3b3e">bs::store</a>(p_out, out.data() + i);</div><div class="line">    }</div></div><!-- fragment --> <h1><a class="anchor" id="substract-hanging-data"></a>
What happens when the input data is not a multiple of the cardinal?</h1>
<p>So, how do we handle the case where the input data is not a multiple of the cardinal? We simply write a scalar loop to handle this extra data.</p>
<div class="fragment"><div class="line">    <span class="comment">// Using explicit load/store</span></div><div class="line">    <span class="comment">// set size to an arbitrary value</span></div><div class="line">    size = 133;</div><div class="line">    pack_t p_out, p_arr, fortytwo{42};</div><div class="line">    array.resize(size);</div><div class="line">    out.resize(size);</div><div class="line">    <span class="keywordtype">size_t</span> i = 0;</div><div class="line">    <span class="keywordflow">for</span> (; i + pack_card &lt;= size; i += pack_card) {</div><div class="line">      p_arr = bs::load&lt;pack_t&gt;(array.data() + i);</div><div class="line">      p_out = p_arr - fortytwo;</div><div class="line">      <a class="code" href="namespaceboost_1_1simd.html#af50789733f52bd58296f90d91b5b3b3e">bs::store</a>(p_out, out.data() + i);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (; i &lt; size; ++i) {</div><div class="line">      out[i] = array[i] - scalar;</div><div class="line">    }</div></div><!-- fragment --><p> There are three main differences between this loop and the previous one. Firstly, the loop counter <code>i</code> is declared outside of the first loop. This is so that its value is retained for use in the second loop. The second difference is seen in the first loops termination condition. The loop is now terminated when <code>i + pack_card &lt;= size</code>. We do this to ensure that we never load data which is past the end of the array. The third and final difference is the second loop. This is almost identical to the scalar loop at the start of this tutorial. The remaining elements in the input array, which are not sufficient to fill a pack are processed individually. A more elegant way of achieving this is demonstrated in the tutorial <a class="el" href="md__d_1_dev_opensource_boost_8simd_doc_custom_sections_tutorials_tutorial_algorithm.html#tutorial-algorithm">Algorithm</a> .</p>
<p>Here is a full code, should you wish to try it:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;boost/simd/function/load.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/simd/function/minus.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/simd/function/store.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/simd/meta/cardinal_of.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/simd/pack.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cstdlib&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;numeric&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><span class="keywordtype">void</span> print(std::string mes, <span class="keyword">const</span> T&amp; out)</div><div class="line">{</div><div class="line">  std::cout &lt;&lt; mes &lt;&lt; std::endl;</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; out.size(); ++i) {</div><div class="line">    <span class="keywordflow">if</span> (i &amp;&amp; (i % 8 == 0))</div><div class="line">      std::cout &lt;&lt; std::endl;</div><div class="line">    std::cout &lt;&lt; std::setw(5) &lt;&lt; out[i] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div><div class="line">  }</div><div class="line">  std::cout &lt;&lt; std::endl &lt;&lt; std::endl;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">  <span class="keyword">namespace </span><a class="code" href="namespaceboost_1_1simd.html">bs</a> = <a class="code" href="namespaceboost_1_1simd.html">boost::simd</a>;</div><div class="line">  <span class="keywordtype">size_t</span> size  = 128;</div><div class="line">  std::vector&lt;int32_t&gt; array(size);</div><div class="line">  std::vector&lt;int32_t&gt; out(size);</div><div class="line">  <span class="comment">// Initialize input array</span></div><div class="line">  <a class="code" href="group__group-algo_gadb2705dba33a162bffe7656b7fe6c32c.html#gadb2705dba33a162bffe7656b7fe6c32c">std::iota</a>(array.begin(), array.end(), 0);</div><div class="line">  int32_t scalar = 42;</div><div class="line"></div><div class="line">  <span class="keyword">using</span> pack_t     = <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int32_t&gt;</a>;</div><div class="line">  <span class="keywordtype">size_t</span> pack_card = <a class="code" href="structboost_1_1simd_1_1cardinal__of.html">bs::cardinal_of&lt;pack_t&gt;</a>();</div><div class="line"></div><div class="line">  <span class="comment">// Scalar version</span></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; ++i) {</div><div class="line">    out[i] = array[i] - scalar;</div><div class="line">  }</div><div class="line">  print(<span class="stringliteral">&quot;scalar loop output&quot;</span>, out);</div><div class="line"></div><div class="line">  {</div><div class="line">    pack_t p_out, pkvalue(scalar);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; i += pack_card) {</div><div class="line">      pack_t p_arr(array.data() + i);</div><div class="line">      p_out = p_arr - pkvalue;</div><div class="line">      <a class="code" href="namespaceboost_1_1simd.html#af50789733f52bd58296f90d91b5b3b3e">bs::store</a>(p_out, out.data() + i);</div><div class="line">    }</div><div class="line">    print(<span class="stringliteral">&quot;SIMD 1 loop output&quot;</span>, out);</div><div class="line">  }</div><div class="line"></div><div class="line">  {</div><div class="line">    pack_t p_out, p_arr, pkvalue{scalar};</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; i += pack_card) {</div><div class="line">      p_arr = bs::load&lt;pack_t&gt;(array.data() + i);</div><div class="line">      p_out = p_arr - pkvalue;</div><div class="line">      <a class="code" href="namespaceboost_1_1simd.html#af50789733f52bd58296f90d91b5b3b3e">bs::store</a>(p_out, out.data() + i);</div><div class="line">    }</div><div class="line">    print(<span class="stringliteral">&quot;SIMD 2 loop output&quot;</span>, out);</div><div class="line">  }</div><div class="line"></div><div class="line">  {</div><div class="line">    <span class="comment">// set size to an arbitrary value</span></div><div class="line">    size = 133;</div><div class="line">    pack_t p_out, p_arr, pkvalue{scalar};</div><div class="line">    array.resize(size);</div><div class="line">    out.resize(size);</div><div class="line">    <a class="code" href="group__group-algo_gadb2705dba33a162bffe7656b7fe6c32c.html#gadb2705dba33a162bffe7656b7fe6c32c">std::iota</a>(array.begin(), array.end(), 0);</div><div class="line">    <span class="keywordtype">size_t</span> i = 0;</div><div class="line">    <span class="keywordflow">for</span> (; i + pack_card &lt;= size; i += pack_card) {</div><div class="line">      p_arr = bs::load&lt;pack_t&gt;(array.data() + i);</div><div class="line">      p_out = p_arr - pkvalue;</div><div class="line">      <a class="code" href="namespaceboost_1_1simd.html#af50789733f52bd58296f90d91b5b3b3e">bs::store</a>(p_out, out.data() + i);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (; i &lt; size; ++i) {</div><div class="line">      out[i] = array[i] - scalar;</div><div class="line">    }</div><div class="line">    print(<span class="stringliteral">&quot;SIMD 3 loop output&quot;</span>, out);</div><div class="line">  }</div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"><span class="comment">// This code can be compiled using (for instance for gcc)</span></div><div class="line"><span class="comment">// g++ substract.cpp -msse4.2 -std=c++11 -O3 -DNDEBUG -o substract</span></div><div class="line"><span class="comment">// -I/path_to/boost_simd/ -I/path_to/boost/</span></div></div><!-- fragment --> <div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-simd-loop.html">A Basic SIMD Loop</a></div> <div style="text-align: right;" markdown="1">Next: <a class="el" href="tutorial-memory.html">Memory Alignment</a></div> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="footer"/>
        <address class="footer">
            <small>
                Generated on Fri Jun 9 2017 10:01:40 for Boost.SIMD by &#160;
                <a href="http://www.doxygen.org/index.html">
                    <img class="footer" src="doxygen.png" alt="doxygen"/>
                </a>
                1.8.13
            </small>
        </address>
    </body>
</html>
