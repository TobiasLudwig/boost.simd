<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.13"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.smartmenus/1.0.1/jquery.smartmenus.js"></script>
        <title>Boost.SIMD: Runtime Extension Selection</title>
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/SVG"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link rel="icon" href="numscale_icon.png">
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="ns.css" rel="stylesheet" type="text/css"/>
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="ns.js"></script>
        <script type="text/javascript" src="custom.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header responsive-logo"/>
                    <a class="navbar-brand" href="http://developer.numscale.com/">
                        <span>Boost.SIMD</span>
                    </a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li id="version">
                            <a href="#" class="disabled">4.17.6.0</a>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a target="_blank" id="right-logo" href="http://www.numscale.com/" title="Numscale">
                                <img height=60 src="numscale.png" alt="Numscale">
                            </a>
                        </li>
                    </ul>
                </div><!-- /.navbar-collapse -->
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 35px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Runtime Extension Selection </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#runtime-objectives">Objectives</a></li>
<li class="level1"><a href="#tutorial-runtime-intro">Introduction</a></li>
<li class="level1"><a href="#tutorial-runtime-dispatch">How to select the correct extension at runtime</a></li>
</ul>
</div>
<div class="textblock"><div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-nbody.html">Evaluation of the N-Body problem</a></div> <div style="text-align: right;" markdown="1">Next: <a class="el" href="tutorial-distance.html">Distance between 2D Points</a></div><p>In this tutorial we will demonstrate the use of SIMD extension selection at runtime.</p>
<h1><a class="anchor" id="runtime-objectives"></a>
Objectives</h1>
<hr/>
<p>In this tutorial we will:</p><ul>
<li><a href="#tutorial-runtime-intro">Explain why runtime extension selection is very useful</a></li>
<li><a href="#tutorial-runtime-dispatch">Show you how to select the correct architecture at runtime</a></li>
</ul>
<h1><a class="anchor" id="tutorial-runtime-intro"></a>
Introduction</h1>
<hr/>
<p>The selection of SIMD extensions at runtime enables you to release one executable which will be of the highest performance possible on many different architectures. Without runtime extension selection, an executable released must be compiled for the earliest generation of processor targeted, which is often SSE2. This means that you are artificially restricting the performance of your software for your clients which have more modern processors. <b>Boost.SIMD</b> provides everything you need to be able to target multiple architectures with one binary.</p>
<h1><a class="anchor" id="tutorial-runtime-dispatch"></a>
How to select the correct extension at runtime</h1>
<hr/>
<p>In this section, we will demonstrate how to compile your program for several different generations of x86 processors and select automatically the correct version at runtime. In order to do this, you must add an extra argument to the function you wish to call so that the correct function will be found at runtime.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> compute(<span class="keywordtype">float</span>* a, <span class="keywordtype">float</span>* b, <span class="keywordtype">float</span>* res, <span class="keywordtype">int</span> size, BOOST_SIMD_DEFAULT_SITE <span class="keyword">const</span>&amp; arch)</div><div class="line">{</div></div><!-- fragment --><p> The macro BOOST_SIMD_DEFAULT_SITE is set according to the architecture that the currect file is being compiled for. You must also declare a prototype for each architecture that you wish to target:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> compute(<span class="keywordtype">float</span> *a, <span class="keywordtype">float</span> *b, <span class="keywordtype">float</span> *res, <span class="keywordtype">int</span> size, boost::simd::avx2_ <span class="keyword">const</span>&amp;);</div><div class="line"><span class="keywordtype">void</span> compute(<span class="keywordtype">float</span> *a, <span class="keywordtype">float</span> *b, <span class="keywordtype">float</span> *res, <span class="keywordtype">int</span> size, boost::simd::avx_ <span class="keyword">const</span>&amp;);</div><div class="line"><span class="keywordtype">void</span> compute(<span class="keywordtype">float</span> *a, <span class="keywordtype">float</span> *b, <span class="keywordtype">float</span> *res, <span class="keywordtype">int</span> size, boost::simd::sse4_2_ <span class="keyword">const</span>&amp;);</div><div class="line"><span class="keywordtype">void</span> compute(<span class="keywordtype">float</span> *a, <span class="keywordtype">float</span> *b, <span class="keywordtype">float</span> *res, <span class="keywordtype">int</span> size, boost::simd::sse4_1_ <span class="keyword">const</span>&amp;);</div><div class="line"><span class="keywordtype">void</span> compute(<span class="keywordtype">float</span> *a, <span class="keywordtype">float</span> *b, <span class="keywordtype">float</span> *res, <span class="keywordtype">int</span> size, boost::simd::sse3_ <span class="keyword">const</span>&amp;);</div><div class="line"><span class="keywordtype">void</span> compute(<span class="keywordtype">float</span> *a, <span class="keywordtype">float</span> *b, <span class="keywordtype">float</span> *res, <span class="keywordtype">int</span> size, boost::simd::sse2_ <span class="keyword">const</span>&amp;);</div><div class="line"><span class="keywordtype">void</span> compute(<span class="keywordtype">float</span> *a, <span class="keywordtype">float</span> *b, <span class="keywordtype">float</span> *res, <span class="keywordtype">int</span> size, boost::dispatch::cpu_ <span class="keyword">const</span>&amp;);</div></div><!-- fragment --><p> In this case, we are compiling a version of our function for each iteration of x86 from sse2 to avx2. You must then call the correct version of your code, depending on the architecture the binary is run on. The order of the conditions in the if-block is very important as each generation of a processor in **Boost.SIMD@**, inherits from the previous generation. This means that sse2 is supported on an sse4.2 equipped processor, for example.</p>
<div class="fragment"><div class="line">  <span class="keyword">namespace </span><a class="code" href="namespaceboost_1_1simd.html">bs</a> = <a class="code" href="namespaceboost_1_1simd.html">boost::simd</a>;</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (bs::avx2.is_supported()) {</div><div class="line">    compute(a.data(), b.data(), res.data(), size, bs::avx2_{});</div><div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bs::avx.is_supported()) {</div><div class="line">    compute(a.data(), b.data(), res.data(), size, bs::avx_{});</div><div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bs::sse4_2.is_supported()) {</div><div class="line">    compute(a.data(), b.data(), res.data(), size, bs::sse4_2_{});</div><div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bs::sse4_1.is_supported()) {</div><div class="line">    compute(a.data(), b.data(), res.data(), size, bs::sse4_1_{});</div><div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bs::sse2.is_supported()) {</div><div class="line">    compute(a.data(), b.data(), res.data(), size, bs::sse3_{});</div><div class="line">  }</div></div><!-- fragment --><p> Once you have compiled your file for each required architecture, you must link your executable with each version of your code. On Linux, using cmake, this is done as follows:</p>
<div class="fragment"><div class="line">cmake_minimum_required(VERSION 2.8)</div><div class="line"></div><div class="line"><span class="keyword">set</span>(CWD ${CMAKE_CURRENT_SOURCE_DIR})</div><div class="line"></div><div class="line"><span class="keyword">set</span>(CMAKE_C_COMPILER gcc)</div><div class="line"><span class="keyword">set</span>(CMAKE_CXX_COMPILER g++)</div><div class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="stringliteral">&quot;${CMAKE_CXX_FLAGS} -std=c++11 -O3&quot;</span>)</div><div class="line"><span class="keyword">set</span>(CMAKE_BUILD_TYPE Release)</div><div class="line"></div><div class="line">include_directories($ENV{BOOST_ROOT})</div><div class="line">include_directories($ENV{SIMD_ROOT})</div><div class="line"></div><div class="line">add_library(test_sse SHARED compute.cpp)</div><div class="line">add_library(test_sse2 SHARED compute.cpp)</div><div class="line">add_library(test_sse3 SHARED compute.cpp)</div><div class="line">add_library(test_sse4.1 SHARED compute.cpp)</div><div class="line">add_library(test_sse4.2 SHARED compute.cpp)</div><div class="line">add_library(test_avx SHARED compute.cpp)</div><div class="line">add_library(test_avx2 SHARED compute.cpp)</div><div class="line"></div><div class="line">set_target_properties(test_sse2 PROPERTIES COMPILE_FLAGS <span class="stringliteral">&quot;-msse2&quot;</span>)</div><div class="line">set_target_properties(test_sse3 PROPERTIES COMPILE_FLAGS <span class="stringliteral">&quot;-msse3&quot;</span>)</div><div class="line">set_target_properties(test_sse4.1 PROPERTIES COMPILE_FLAGS <span class="stringliteral">&quot;-msse4.1&quot;</span>)</div><div class="line">set_target_properties(test_sse4.2 PROPERTIES COMPILE_FLAGS <span class="stringliteral">&quot;-msse4.2&quot;</span>)</div><div class="line">set_target_properties(test_avx PROPERTIES COMPILE_FLAGS <span class="stringliteral">&quot;-mavx&quot;</span>)</div><div class="line">set_target_properties(test_avx2 PROPERTIES COMPILE_FLAGS <span class="stringliteral">&quot;-mavx2&quot;</span>)</div><div class="line"></div><div class="line">add_executable(runtime_extension runtime_extension.cpp)</div><div class="line"></div><div class="line">target_link_libraries(runtime_extension test_sse2 test_sse3 test_sse4.1 test_sse4.2 test_avx test_avx2)</div></div><!-- fragment --><p> Using Microsoft Visual Studio, this can be done be setting the correct properties for your project. See <a class="el" href="quickstart.html#win-compilation">Compiling for Windows</a> for more details.</p>
<div style="text-align: right;" markdown="1">Prev: <a class="el" href="tutorial-nbody.html">Evaluation of the N-Body problem</a></div> <div style="text-align: right;" markdown="1">Next: <a class="el" href="tutorial-distance.html">Distance between 2D Points</a></div> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="footer"/>
        <address class="footer">
            <small>
                Generated on Fri Jun 9 2017 10:01:40 for Boost.SIMD by &#160;
                <a href="http://www.doxygen.org/index.html">
                    <img class="footer" src="doxygen.png" alt="doxygen"/>
                </a>
                1.8.13
            </small>
        </address>
    </body>
</html>
